#!/bin/bash

# Get the directory of the current script
SCRIPT_DIR=$(dirname "$(realpath "$0")")

# Define color and formatting constants
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Function to print a header
print_header() {
    echo -e "\n${BOLD}${BLUE}== $1 ==${NC}"
}

# Function to print a section
print_section() {
    echo -e "\n${BOLD}${YELLOW}-- $1 --${NC}"
}

# Function to print success message
print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

# Function to print error message
print_error() {
    echo -e "${RED}✗ $1${NC}"
}

# Function to print warning message
print_warning() {
    echo -e "${YELLOW}! $1${NC}"
}

# Function to print info message
print_info() {
    echo -e "${BLUE}> $1${NC}"
}

# Check if a command was provided
if [ $# -eq 0 ]; then
    print_header "PostgreSQL Container Manager"
    echo -e "${BOLD}Usage:${NC} pg [command]"
    echo -e "\n${BOLD}Commands:${NC}"
    echo -e "  ${GREEN}start${NC}  - Start PostgreSQL containers"
    echo -e "  ${BLUE}status${NC} - Check if PostgreSQL containers are running and display connection information"
    echo -e "  ${YELLOW}stop${NC}   - Stop PostgreSQL containers"
    echo -e "  ${RED}clean${NC}  - Stop PostgreSQL containers and remove volumes"
    echo -e "  ${YELLOW}fix${NC}    - Detect and fix port conflicts by shutting down conflicting containers"
    exit 1
fi

# Execute the appropriate command
case "$1" in
    start)
        print_header "Starting PostgreSQL Containers"
        # Run docker compose up and capture the exit code
        print_info "Running docker compose up..."
        docker compose -f ${SCRIPT_DIR}/docker-compose.yaml up -d
        UP_EXIT_CODE=$?

        # Check if docker compose up was successful
        if [ $UP_EXIT_CODE -eq 0 ]; then
            print_success "PostgreSQL containers started successfully"
            print_section "Container Status"
            docker compose -f ${SCRIPT_DIR}/docker-compose.yaml \
                ps --format "table {{.ID}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}\t{{.Names}}"
        else
            print_error "Failed to start PostgreSQL containers"
            print_section "Port Conflict Detection"
            print_info "Checking for port conflicts..."

            # Check for containers using PostgreSQL port (15432)
            PG_CONFLICT=$(docker ps --format "{{.Names}}" -f "publish=15432")
            if [ ! -z "$PG_CONFLICT" ]; then
                print_warning "Port conflict detected: Port 15432 is already in use by container: $PG_CONFLICT"
                print_section "PostgreSQL Container Details"
                docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Image}}\t{{.Ports}}" -f "publish=15432"

                # Try to find the Docker Compose project for the conflicting container
                COMPOSE_PROJECT=$(docker inspect $PG_CONFLICT --format '{{index .Config.Labels "com.docker.compose.project"}}')
                if [ ! -z "$COMPOSE_PROJECT" ]; then
                    print_info "This container belongs to Docker Compose project: $COMPOSE_PROJECT"

                    # Try to find the Docker Compose file
                    COMPOSE_CONFIG=$(docker inspect $PG_CONFLICT --format '{{index .Config.Labels "com.docker.compose.project.config_files"}}')
                    if [ ! -z "$COMPOSE_CONFIG" ]; then
                        print_info "Docker Compose file: $COMPOSE_CONFIG"
                    fi

                    # Try to find the Docker Compose working directory
                    COMPOSE_WORKING_DIR=$(docker inspect $PG_CONFLICT --format '{{index .Config.Labels "com.docker.compose.project.working_dir"}}')
                    if [ ! -z "$COMPOSE_WORKING_DIR" ]; then
                        # Store the working directory for later use
                        PG_COMPOSE_WORKING_DIR="$COMPOSE_WORKING_DIR"
                        PG_COMPOSE_PROJECT="$COMPOSE_PROJECT"
                    fi
                fi
            fi

            # Check for containers using pgAdmin port (15433)
            PGADMIN_CONFLICT=$(docker ps --format "{{.Names}}" -f "publish=15433")
            if [ ! -z "$PGADMIN_CONFLICT" ]; then
                print_warning "Port conflict detected: Port 15433 is already in use by container: $PGADMIN_CONFLICT"
                print_section "pgAdmin Container Details"
                docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Image}}\t{{.Ports}}" -f "publish=15433"

                # Try to find the Docker Compose project for the conflicting container
                COMPOSE_PROJECT=$(docker inspect $PGADMIN_CONFLICT --format '{{index .Config.Labels "com.docker.compose.project"}}')
                if [ ! -z "$COMPOSE_PROJECT" ]; then
                    print_info "This container belongs to Docker Compose project: $COMPOSE_PROJECT"

                    # Try to find the Docker Compose file
                    COMPOSE_CONFIG=$(docker inspect $PGADMIN_CONFLICT --format '{{index .Config.Labels "com.docker.compose.project.config_files"}}')
                    if [ ! -z "$COMPOSE_CONFIG" ]; then
                        print_info "Docker Compose file: $COMPOSE_CONFIG"
                    fi

                    # Try to find the Docker Compose working directory
                    COMPOSE_WORKING_DIR=$(docker inspect $PGADMIN_CONFLICT --format '{{index .Config.Labels "com.docker.compose.project.working_dir"}}')
                    if [ ! -z "$COMPOSE_WORKING_DIR" ]; then
                        # Store the working directory for later use
                        PGADMIN_COMPOSE_WORKING_DIR="$COMPOSE_WORKING_DIR"
                        PGADMIN_COMPOSE_PROJECT="$COMPOSE_PROJECT"
                    fi
                fi
            fi

            print_section "Resolution Steps"
            print_info "To resolve this conflict, you can either:"
            echo "  1. Stop the conflicting containers using 'docker stop <container_name>'"
            echo "  2. Modify the docker-compose.yaml file to use different ports"

            # If we have Docker Compose information, show the command to shut down the conflicting containers
            if [ ! -z "${PG_COMPOSE_WORKING_DIR}" ] || [ ! -z "${PGADMIN_COMPOSE_WORKING_DIR}" ]; then
                print_section "Docker Compose Shutdown Commands"

                if [ ! -z "${PG_COMPOSE_WORKING_DIR}" ]; then
                    print_info "To shut down the conflicting PostgreSQL container using Docker Compose:"
                    echo "  docker compose -f ${PG_COMPOSE_WORKING_DIR}/docker-compose.yaml down"
                fi

                if [ ! -z "${PGADMIN_COMPOSE_WORKING_DIR}" ] && [ "${PG_COMPOSE_WORKING_DIR}" != "${PGADMIN_COMPOSE_WORKING_DIR}" ]; then
                    print_info "To shut down the conflicting pgAdmin container using Docker Compose:"
                    echo "  docker compose -f ${PGADMIN_COMPOSE_WORKING_DIR}/docker-compose.yaml down"
                fi

                print_info "Or simply run: pg fix"
            fi

            # Exit with the original error code
            exit $UP_EXIT_CODE
        fi
        ;;
    stop)
        print_header "Stopping PostgreSQL Containers"
        print_info "Running docker compose down..."
        docker compose -f ${SCRIPT_DIR}/docker-compose.yaml down
        print_success "PostgreSQL containers stopped successfully"
        ;;
    clean)
        print_header "Cleaning PostgreSQL Containers and Volumes"
        print_warning "This will remove all data in the PostgreSQL volumes"
        print_info "Running docker compose down with volumes..."
        docker compose -f ${SCRIPT_DIR}/docker-compose.yaml down -v
        print_success "PostgreSQL containers and volumes cleaned successfully"
        ;;
    status)
        print_header "PostgreSQL Status"
        print_section "Container Status"
        docker compose -f ${SCRIPT_DIR}/docker-compose.yaml ps --format "table {{.Service}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"

        # Check if containers are running
        if docker compose -f ${SCRIPT_DIR}/docker-compose.yaml ps --services --filter "status=running" | grep -q "postgres"; then
            print_success "PostgreSQL is running"

            print_section "PostgreSQL Connection Information"
            echo -e "${BOLD}Host:${NC}     localhost"
            echo -e "${BOLD}Port:${NC}     15432"
            echo -e "${BOLD}Username:${NC} postgres"
            echo -e "${BOLD}Password:${NC} password"
            echo -e "${BOLD}Database:${NC} postgres"

            print_section "JDBC Connection URL"
            echo "jdbc:postgresql://localhost:15432/postgres"

            print_section "PSQL Command"
            echo "PGPASSWORD=password psql -h localhost -p 15432 -U postgres -d postgres"

            if docker compose -f ${SCRIPT_DIR}/docker-compose.yaml ps --services --filter "status=running" | grep -q "pgadmin"; then
                print_success "pgAdmin is running"

                print_section "pgAdmin Information"
                echo -e "${BOLD}URL:${NC}      http://localhost:15433"
                echo -e "${BOLD}Email:${NC}    admin@example.com"
                echo -e "${BOLD}Password:${NC} admin"
            else
                print_warning "pgAdmin is not running"
            fi
        else
            print_error "PostgreSQL is not running"
        fi
        ;;
    fix)
        print_header "Fixing Port Conflicts"
        print_info "Detecting port conflicts..."

        # Check for containers using PostgreSQL port (15432)
        PG_CONFLICT=$(docker ps --format "{{.Names}}" -f "publish=15432")
        PG_COMPOSE_FILE=""

        if [ ! -z "$PG_CONFLICT" ]; then
            print_warning "Port conflict detected: Port 15432 is already in use by container: $PG_CONFLICT"

            # Try to find the Docker Compose project for the conflicting container
            COMPOSE_WORKING_DIR=$(docker inspect $PG_CONFLICT --format '{{index .Config.Labels "com.docker.compose.project.working_dir"}}')
            if [ ! -z "$COMPOSE_WORKING_DIR" ]; then
                PG_COMPOSE_FILE="${COMPOSE_WORKING_DIR}/docker-compose.yaml"
                print_info "Found Docker Compose file: $PG_COMPOSE_FILE"
            fi
        fi

        # Check for containers using pgAdmin port (15433)
        PGADMIN_CONFLICT=$(docker ps --format "{{.Names}}" -f "publish=15433")
        PGADMIN_COMPOSE_FILE=""

        if [ ! -z "$PGADMIN_CONFLICT" ]; then
            print_warning "Port conflict detected: Port 15433 is already in use by container: $PGADMIN_CONFLICT"

            # Try to find the Docker Compose project for the conflicting container
            COMPOSE_WORKING_DIR=$(docker inspect $PGADMIN_CONFLICT --format '{{index .Config.Labels "com.docker.compose.project.working_dir"}}')
            if [ ! -z "$COMPOSE_WORKING_DIR" ] && [ "$PG_COMPOSE_FILE" != "${COMPOSE_WORKING_DIR}/docker-compose.yaml" ]; then
                PGADMIN_COMPOSE_FILE="${COMPOSE_WORKING_DIR}/docker-compose.yaml"
                print_info "Found Docker Compose file: $PGADMIN_COMPOSE_FILE"
            fi
        fi

        # Shut down conflicting containers
        if [ ! -z "$PG_COMPOSE_FILE" ]; then
            print_info "Shutting down containers from: $PG_COMPOSE_FILE"
            docker compose -f "$PG_COMPOSE_FILE" down
            print_success "Successfully shut down containers from: $PG_COMPOSE_FILE"
        fi

        if [ ! -z "$PGADMIN_COMPOSE_FILE" ]; then
            print_info "Shutting down containers from: $PGADMIN_COMPOSE_FILE"
            docker compose -f "$PGADMIN_COMPOSE_FILE" down
            print_success "Successfully shut down containers from: $PGADMIN_COMPOSE_FILE"
        fi

        if [ -z "$PG_COMPOSE_FILE" ] && [ -z "$PGADMIN_COMPOSE_FILE" ]; then
            print_success "No port conflicts detected or no Docker Compose files found for conflicting containers"
        else
            print_success "Port conflicts resolved. You can now run 'pg start' to start your PostgreSQL containers"
        fi
        ;;
    *)
        print_header "Unknown Command: $1"
        echo -e "${BOLD}Usage:${NC} pg [command]"
        echo -e "\n${BOLD}Commands:${NC}"
        echo -e "  ${GREEN}start${NC}  - Start PostgreSQL containers"
        echo -e "  ${BLUE}status${NC} - Check if PostgreSQL containers are running and display connection information"
        echo -e "  ${YELLOW}stop${NC}   - Stop PostgreSQL containers"
        echo -e "  ${RED}clean${NC}  - Stop PostgreSQL containers and remove volumes"
        echo -e "  ${YELLOW}fix${NC}    - Detect and fix port conflicts by shutting down conflicting containers"
        exit 1
        ;;
esac
